# vkTechnoTest

## Сервис подписок

[Информация](#информация)  
[Конфигурация](#конфигурация)  
[Сборка и установка](#сборка-и-установка)

### Информация

#### Сервер

##### Подписка
Подписка осуществляется с помощью вызова функции `Subscribe`  
Отмена подписки осуществляется закрытием горутины подписчика (а точнее, вызовом функции `cancel`, возвращаемой
функцией `context.WithCancel`)

##### Публикация
Публикация осуществляется с помощью вызова функции `Publish`  
Функция публикации должна получить ключ и сообщение (`key`, `data`)

##### Логирование
Логирование осуществляется с помощью пакета `log`  
Вывод логов осуществляется в стандартный поток вывода с пометкой `[pubsub]`  
При необходимости, путь отправки логов может быть изменен в файле `service/config.go` в функции `NewLogger()`  

**Что логируется?**
- Новые подписки
- Новые публикации
- Отмена подписки
- Ошибки

##### Особенности реализации

- Реализован паттерн `graceful shutdown` как для самого сервера, так и для пакета `subpub`  

**Что это значит?**  
При завершении работы сервера, блокируются входящие соединения. Существующие соединения будут заблокированы после
завершения функций-обработчиков. Когда соединений не останется, сервер завершит свою работу.

- Конкурентное выполнение функций-обработчиков подписчиков

Чтобы медленные подписчики не тормозили более быстрых подписчиков (подписчиков, функции-обработчики которых работают 
быстрее), все функции-обработчики выполняются в отдельных горутинах.  
В этом случае, порядок выполнения функций **на сервере** не определен, однако порядок выполнения функций-обработчиков
одного подписчика будет сохранён.

**Пример**  
Есть два подписчика на ключ `test`, функция-обработчик первой выполняется **5** секунд, второй - **1** секунда.
Поступает 2 публикации на заданный ключ с интервалом, менее чем в 0.5 секунд (за время выполнения обработчика второго 
подписчика оба сообщения уже поступили).  
Тогда в логах сервера порядок сообщений будет нарушен (второй обработает оба сообщения, пока первый обрабатывает
1 сообщение). Однако подписчики получат сообщения в правильном порядке.

#### Клиент
Для взаимодействия с сервисом необходимо клиентское приложение (далее - клиент)
##### Готовый клиент
Для установки готового клиентского пакета
```go
import "github.com/k3sslerX/vkTechnoTest/subsribeservice/client"
```
Пример использования клиентского пакета располагается в `cmd_client/main.go`

##### Собственный клиент
Для написания собственного клиентского пакета необходимо импортировать protoBuf сервиса `proto/pubsub`
```go
import "github.com/k3sslerX/vkTechnoTest/subsribeservice/proto/pubsub"
```

#### Тестирование
Unit-тесты проводились с помощью утилиты `go test`  
Тестовые данные представлены в файле `unit_test.go` пакета `subpub`, Job `lint-and-test`  
Результаты тестирования представлены в CI-пайплайне *GitHub Actions*

Детали деплоя самого сервиса представлены в CD-пайплайне *GitHub Actions*, Job `build-and-push-subsservice`

### Конфигурация
Конфигурация настраивается через переменные окружения

Доступные конфигурации:

- `SUBSSERVICE_GRPC_PORT`
  - **Формат:** `:XXXX`
  - **Описание:** Порт прослушивания gRPC сервера
  - **Пример:** `SUBSSERVICE_GRPC_PORT=:8080`
  - **По умолчанию:** `:1313`
- `SUBSSERVICE_TIMEOUT`
  - **Формат:** `XXs`
  - **Описание:** Тайм-аут времени ответа от сервера/клиента
  - **Пример:** `SUBSSERVICE_TIMEOUT=10s`
  - **По умолчанию:** `5s`

### Сборка и установка

Доступно **3** способа установки сервиса:

1. Локальная сборка самого сервиса
2. Локальная сборка Docker-образа
3. Установка готового Docker-образа через GitHub Container Registry

#### 1. Локальная сборка

1. Склонируйте или скачайте исходный код репозитория

```bash
git clone https://github.com/k3sslerX/vkTechnoTest.git
cd vkTechnoTest
```

2. Перейдите в папку `subscribeservice`

```bash
cd subscribeservice
```

3. Установите зависимости

```bash
go mod download
```

4. Соберите проект

```bash
go build ./cmd_server/main.go
```

Если требуется собственное имя файла

```bash
go build -o filename ./cmd/server/main.go
```

5. Запустите сервис

```bash
./main
```

С собственным именем файла:

```bash
./filename
```

#### 2. Сборка Docker-образа

1. Склонируйте или скачайте исходный код репозитория

```bash
git clone https://github.com/k3sslerX/vkTechnoTest.git
cd vkTechnoTest
```

2. Соберите Docker-образ

```bash
docker build -t subscribeservice:latest -f subscribeservice/Dockerfile .
```

3. Запустите Docker-контейнер с нужными портами

```bash
docker run -d -p 1313:1313 subscribeservice:latest
```

#### 3. GitHub Container Registry

1. Скачайте готовый Docker-образ через *ghcr.io*

```bash
docker pull ghcr.io/k3sslerx/vktechnotest/subscribeservice:latest
```

*Актуальный Docker-образ можно найти во вкладке `Packages` GitHub репозитория

2. Запустите Docker-контейнер

```bash
docker run -d -p 1313:1313 ghcr.io/k3sslerx/vktechnotest/subscribeservice:latest
```

3. *Ошибки платформы

При возникновении ошибок с поддержкой платформы 

```bash
Error response from daemon: no matching manifest for linux/arm64/v8 in the manifest list entries: no match for platform in manifest: not found
```

требуется явно указать платформу при скачивании Docker-образа

```bash
docker pull --platform linux/amd64 ghcr.io/k3sslerx/vktechnotest/subscribeservice:latest
```
